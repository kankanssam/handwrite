<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†ê¸€ì”¨ ì—°ìŠµì¥ - ìŠ¤í¬ë¡¤ ë° ë˜ëŒë¦¬ê¸° ì¶”ê°€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo&family=Nanum+Pen+Script&family=Noto+Sans+KR&family=Gaegu&family=Gowun+Batang&family=Poor+Story&display=swap" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f3f4f6;
        }
        /* ë ˆì´ì•„ì›ƒ ìˆ˜ì •: ì „ì²´ ë†’ì´ë¥¼ ì±„ìš°ë„ë¡ ì„¤ì • */
        .app-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        @media (min-width: 768px) {
            .app-wrapper { flex-direction: row; }
        }
        
        #canvas-container {
            position: relative;
            flex-grow: 1;
            overflow-y: auto; /* ìƒí•˜ ìŠ¤í¬ë¡¤ í—ˆìš© */
            overflow-x: hidden;
            background-color: #f9fafb;
            -webkit-overflow-scrolling: touch;
        }
        
        canvas {
            display: block;
            touch-action: none; /* ë“œë¡œì‰ ì‹œ ë¸Œë¼ìš°ì € ê¸°ë³¸ ìŠ¤í¬ë¡¤ ë°©í•´ ê¸ˆì§€ (JSì—ì„œ ì œì–´) */
            background-color: transparent;
        }
        .grid-layer {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            user-select: none;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        #resultToast {
            position: fixed;
            bottom: 60px;
            right: 20px;
            padding: 1rem 2rem;
            background: #1f2937;
            color: white;
            border-radius: 0.5rem;
            display: none;
            z-index: 50;
        }
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        footer {
            background: rgba(255, 255, 255, 0.9);
            border-top: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.75rem;
            color: #6b7280;
            z-index: 40;
        }
    </style>
</head>
<body>

<div class="app-wrapper">
    <aside class="w-full md:w-1/4 lg:w-1/5 bg-white shadow-xl p-6 z-20 flex flex-col gap-4 overflow-y-auto border-r border-gray-200">
        <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
            <span class="text-2xl">ğŸ–‹ï¸</span> ì†ê¸€ì”¨ ê¸°ë¡ì¥
        </h1>
        
        <div class="flex flex-col gap-1">
            <label class="text-xs font-bold text-gray-500">ì—°ìŠµí•  ë¬¸ì¥</label>
            <textarea id="inputText" class="w-full p-2 border border-gray-300 rounded-lg text-sm outline-none resize-none" rows="2">ì •ë³´ ë° ì¸ê³µì§€ëŠ¥ê¸°ì´ˆ êµê³¼í•™ìŠµì„ ìœ„í•œ ì†ê¸€ì”¨ ì“°ê¸°.</textarea>
        </div>

        <div class="grid grid-cols-2 gap-2">
            <div class="flex flex-col gap-1">
                <label class="text-xs font-bold text-gray-500">ê¸€ê¼´</label>
                <select id="fontSelect" class="w-full p-2 border border-gray-300 rounded-lg text-xs outline-none">
                    <option value="'Noto Sans KR'">ë³¸ê³ ë”•</option>
                    <option value="'Nanum Myeongjo'">ë‚˜ëˆ”ëª…ì¡°</option>
                    <option value="'Gowun Batang'">ê³ ìš´ë°”íƒ•</option>
                    <option value="'Nanum Pen Script'">ë‚˜ëˆ”íœ</option>
                    <option value="'Poor Story'">í‘¸ì–´ìŠ¤í† ë¦¬</option>
                </select>
            </div>
            <div class="flex flex-col gap-1">
                <label class="text-xs font-bold text-gray-500">íœ ìƒ‰ìƒ</label>
                <input type="color" id="customColor" class="w-full h-9 p-1 border border-gray-300 rounded-lg cursor-pointer" value="#1a56db">
            </div>
        </div>

        <div class="flex flex-col gap-1">
            <label class="text-xs font-bold text-gray-500">íœ êµµê¸°</label>
            <input type="range" id="strokeRange" min="2" max="15" value="6" class="w-full accent-blue-600">
        </div>

        <div class="flex flex-col gap-2 mt-2">
            <button id="analyzeBtn" class="w-full py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 shadow-md">
                ğŸ¯ íŒì • ë° ê²°ê³¼ ê¸°ë¡
            </button>
            <div class="grid grid-cols-3 gap-1">
                <button id="undoBtn" class="py-2 bg-amber-50 text-amber-600 text-sm font-bold rounded-lg border border-amber-200 hover:bg-amber-100">â†© ë˜ëŒë¦¬ê¸°</button>
                <button id="clearBtn" class="py-2 bg-gray-50 text-gray-600 text-sm font-bold rounded-lg border border-gray-200 hover:bg-gray-100">ì „ì²´ì‚­ì œ</button>
                <button id="downloadBtn" class="py-2 bg-blue-50 text-blue-600 text-sm font-bold rounded-lg border border-blue-200 hover:bg-blue-100">ì €ì¥</button>
            </div>
        </div>

        <div id="scoreDisplay" class="hidden p-3 bg-blue-50 border border-blue-100 rounded-xl text-center">
            <p class="text-xs text-blue-600 font-medium">í˜„ì¬ ì¼ì¹˜ìœ¨</p>
            <p id="percentVal" class="text-2xl font-black text-blue-700">0%</p>
        </div>
    </aside>

    <main id="canvas-container">
        <canvas id="guideCanvas" class="grid-layer"></canvas>
        <canvas id="paintCanvas"></canvas>
    </main>
</div>

<div id="infoModal" class="modal">
    <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 flex flex-col gap-4">
        <h2 class="text-xl font-bold text-gray-800 text-center">ì—°ìŠµ ê²°ê³¼ ê¸°ë¡</h2>
        <p id="modalScoreText" class="text-center text-blue-600 font-bold text-lg mb-2"></p>
        <input type="text" id="studentId" class="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="í•™ë²ˆ (ì˜ˆ: 20101)">
        <input type="text" id="studentName" class="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)">
        <div class="flex gap-2 mt-4">
            <button id="cancelModal" class="flex-1 py-3 bg-gray-100 text-gray-600 font-bold rounded-lg">ì·¨ì†Œ</button>
            <button id="submitInfo" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700">
                <span id="btnText">ì‹œíŠ¸ì— ê¸°ë¡í•˜ê¸°</span>
            </button>
        </div>
    </div>
</div>
<div id="resultToast">ì²˜ë¦¬ ì¤‘...</div>

<footer>
    <p>Â© 2024. <strong>ê¹ê¹ìŒ¤</strong> All rights reserved.</p>
</footer>

<script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbzClrwGAApEdUwU3hxIrKhOOTXtVZo0jBRuiW4OJ4mm4q-b1hWt8EM_M989wq_KF0dT/exec";

    const canvas = document.getElementById('paintCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const guideCanvas = document.getElementById('guideCanvas');
    const gCtx = guideCanvas.getContext('2d');
    const container = document.getElementById('canvas-container');
    
    const inputText = document.getElementById('inputText');
    const fontSelect = document.getElementById('fontSelect');
    const strokeRange = document.getElementById('strokeRange');
    const customColor = document.getElementById('customColor');
    const clearBtn = document.getElementById('clearBtn');
    const undoBtn = document.getElementById('undoBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');

    let isDrawing = false;
    let lastX = 0, lastY = 0;
    let currentAccuracy = 0;
    const cellSize = 140, padding = 30, lineSpacing = 40;

    // ë˜ëŒë¦¬ê¸°ë¥¼ ìœ„í•œ íˆìŠ¤í† ë¦¬ ë°°ì—´
    let undoHistory = [];

    function saveState() {
        if (undoHistory.length > 20) undoHistory.shift(); // ë©”ëª¨ë¦¬ ê´€ë¦¬: ìµœëŒ€ 20íš ì €ì¥
        undoHistory.push(canvas.toDataURL());
    }

    function undo() {
        if (undoHistory.length > 0) {
            let lastState = undoHistory.pop();
            let img = new Image();
            img.src = lastState;
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                // ì´ì „ ë°ì´í„°ê°€ ìˆë‹¤ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸° (ì‹¤ì œë¡œëŠ” popìœ¼ë¡œ êº¼ë‚¸ ì´ì „ ì´ë¯¸ì§€ë¥¼ ë³µêµ¬í•´ì•¼ í•˜ë¯€ë¡œ êµ¬ì¡°ì  ê°œì„  í•„ìš”)
                // ë‹¨ìˆœíˆ ì§ì „ ìƒíƒœë¥¼ ë¶ˆëŸ¬ì˜¤ê¸° ìœ„í•´ history ê´€ë¦¬ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.
                if (undoHistory.length > 0) {
                    let prevState = new Image();
                    prevState.src = undoHistory[undoHistory.length - 1];
                    prevState.onload = () => ctx.drawImage(prevState, 0, 0);
                }
            };
        } else {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    }

    function initCanvas() {
        const containerWidth = container.clientWidth - (padding * 2);
        const charsPerLine = Math.floor(containerWidth / cellSize);
        const text = inputText.value.replace(/\n/g, "");
        const totalLines = Math.ceil(text.length / Math.max(1, charsPerLine));
        const unitHeight = (cellSize * 2) + lineSpacing;
        
        const width = container.clientWidth;
        const height = Math.max(container.clientHeight, (unitHeight * totalLines) + (padding * 5));
        
        // ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì • ì‹œ ê¸°ì¡´ ë‚´ìš© ì†Œì‹¤ ë°©ì§€ë¥¼ ìœ„í•´ ì„ì‹œ ì €ì¥
        const tempImage = canvas.toDataURL();
        
        canvas.width = width; 
        canvas.height = height;
        guideCanvas.width = width; 
        guideCanvas.height = height;
        
        drawGuides(charsPerLine);
        ctx.lineCap = 'round'; 
        ctx.lineJoin = 'round';
        
        // í¬ê¸° ì¡°ì • í›„ ê¸°ì¡´ ê·¸ë¦¼ ë³µêµ¬
        let img = new Image();
        img.src = tempImage;
        img.onload = () => ctx.drawImage(img, 0, 0);
    }

    function drawGuides(charsPerLine) {
        gCtx.clearRect(0, 0, guideCanvas.width, guideCanvas.height);
        const text = inputText.value;
        const font = fontSelect.value;
        for (let i = 0; i < text.length; i++) {
            const lineIndex = Math.floor(i / charsPerLine);
            const charIndexInLine = i % charsPerLine;
            const x = padding + (charIndexInLine * cellSize);
            const yOffset = padding + (lineIndex * ((cellSize * 2) + lineSpacing));
            drawBox(x, yOffset, text[i], font, true);   
            drawBox(x, yOffset + cellSize, text[i], font, false); 
        }
    }

    function drawBox(x, y, char, font, isSource) {
        gCtx.strokeStyle = '#d1d5db'; gCtx.setLineDash([]); gCtx.strokeRect(x, y, cellSize, cellSize);
        gCtx.beginPath(); gCtx.setLineDash([3, 3]); gCtx.strokeStyle = '#e5e7eb';
        for (let i = 1; i < 4; i++) {
            const step = cellSize / 4;
            gCtx.moveTo(x + (i * step), y); gCtx.lineTo(x + (i * step), y + cellSize);
            gCtx.moveTo(x, y + (i * step)); gCtx.lineTo(x + cellSize, y + (i * step));
        }
        gCtx.stroke();
        if (char && char.trim().length > 0) {
            gCtx.textAlign = 'center'; gCtx.textBaseline = 'middle';
            gCtx.font = `${cellSize * 0.65}px ${font}`;
            if (isSource) { gCtx.fillStyle = '#111827'; gCtx.fillText(char, x + cellSize / 2, y + cellSize / 2); } 
            else { gCtx.fillStyle = 'rgba(0,0,0,0.03)'; gCtx.fillText(char, x + cellSize / 2, y + cellSize / 2); }
        }
    }

    // ë§ˆìš°ìŠ¤/í„°ì¹˜ ì¢Œí‘œ ê³„ì‚° (ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë°˜ì˜)
    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        // ìº”ë²„ìŠ¤ì˜ ì‹¤ì œ ì¢Œí‘œ = í´ë¼ì´ì–¸íŠ¸ ì¢Œí‘œ - ìº”ë²„ìŠ¤ ìœ„ì¹˜ + ì»¨í…Œì´ë„ˆì˜ ìŠ¤í¬ë¡¤ëœ ì–‘
        return { 
            x: clientX - rect.left, 
            y: clientY - rect.top
        };
    }

    function startDrawing(e) {
        // ì…ë ¥ ë„êµ¬ê°€ íœì´ê±°ë‚˜ ë§ˆìš°ìŠ¤ì¼ ë•Œë§Œ ê·¸ë¦¼ (ìŠ¤í¬ë¡¤ ë°©í•´ ë°©ì§€)
        // ë§Œì•½ ì†ê°€ë½ìœ¼ë¡œ ë“œë¡œì‰ ëŒ€ì‹  ìŠ¤í¬ë¡¤ì„ ì›í•œë‹¤ë©´ ì´ ë¡œì§ì„ ì¡°ì •í•´ì•¼ í•©ë‹ˆë‹¤.
        // í˜„ì¬ëŠ” ìº”ë²„ìŠ¤ ì˜ì—­ ìœ„ì—ì„œì˜ í„°ì¹˜ëŠ” ë¬´ì¡°ê±´ ë“œë¡œì‰ìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
        isDrawing = true;
        const p = getPos(e);
        [lastX, lastY] = [p.x, p.y];
        saveState(); // íš ì‹œì‘ ì „ í˜„ì¬ ìƒíƒœ ì €ì¥
    }

    function draw(e) {
        if (!isDrawing) return;
        const p = getPos(e);
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(p.x, p.y);
        ctx.strokeStyle = customColor.value;
        ctx.lineWidth = strokeRange.value;
        ctx.stroke();
        [lastX, lastY] = [p.x, p.y];
    }

    function stopDrawing() { isDrawing = false; }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    window.addEventListener('mouseup', stopDrawing);

    // í„°ì¹˜ ì´ë²¤íŠ¸: preventDefaultë¥¼ í†µí•´ ë“œë¡œì‰ ì¤‘ í™”ë©´ì´ ì›€ì§ì´ì§€ ì•Šê²Œ í•¨
    canvas.addEventListener('touchstart', (e) => {
        if (e.target === canvas) {
            e.preventDefault();
            startDrawing(e);
        }
    }, { passive: false });
    canvas.addEventListener('touchmove', (e) => {
        if (isDrawing) {
            e.preventDefault();
            draw(e);
        }
    }, { passive: false });
    canvas.addEventListener('touchend', stopDrawing);

    undoBtn.onclick = undo;
    clearBtn.onclick = () => {
        if(confirm("ëª¨ë“  ë‚´ìš©ì„ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            undoHistory = [];
            document.getElementById('scoreDisplay').classList.add('hidden');
        }
    };
    
    inputText.addEventListener('input', initCanvas);
    fontSelect.addEventListener('change', initCanvas);
    analyzeBtn.onclick = analyzeHandwriting;
    window.addEventListener('resize', initCanvas);
    window.onload = initCanvas;

    // ë¶„ì„ ë° ëª¨ë‹¬ ì œì–´ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    function analyzeHandwriting() {
        const originalText = inputText.value; if (!originalText.trim()) return;
        const containerWidth = container.clientWidth - (padding * 2);
        const charsPerLine = Math.floor(containerWidth / cellSize);
        const font = fontSelect.value;
        
        const offCanvas = document.createElement('canvas');
        offCanvas.width = canvas.width; offCanvas.height = canvas.height;
        const oCtx = offCanvas.getContext('2d');
        oCtx.font = `${cellSize * 0.65}px ${font}`; oCtx.textAlign = 'center'; oCtx.textBaseline = 'middle';
        
        let totalMatchScore = 0, validChars = 0;
        for (let i = 0; i < originalText.length; i++) {
            const char = originalText[i]; if (!char || char.trim().length === 0) continue;
            const x = padding + ((i % charsPerLine) * cellSize);
            const y = padding + (Math.floor(i / charsPerLine) * ((cellSize * 2) + lineSpacing)) + cellSize;
            
            oCtx.clearRect(x, y, cellSize, cellSize);
            oCtx.fillText(char, x + cellSize / 2, y + cellSize / 2);
            
            const answerData = oCtx.getImageData(x, y, cellSize, cellSize).data;
            const userData = ctx.getImageData(x, y, cellSize, cellSize).data;
            
            let match = 0, answerPixels = 0, userPixels = 0;
            for (let j = 3; j < answerData.length; j += 4) {
                if (answerData[j] > 20) answerPixels++;
                if (userData[j] > 20) userPixels++;
                if (answerData[j] > 20 && userData[j] > 20) match++;
            }
            if (userPixels > 10) { totalMatchScore += Math.min((match / answerPixels) * 100, 100); validChars++; }
        }
        currentAccuracy = validChars > 0 ? Math.round(totalMatchScore / validChars) : 0;
        document.getElementById('percentVal').textContent = currentAccuracy + '%';
        document.getElementById('scoreDisplay').classList.remove('hidden');
        document.getElementById('modalScoreText').textContent = `í‰ê·  ì •í™•ë„: ${currentAccuracy}%`;
        document.getElementById('infoModal').style.display = 'flex';
    }

    document.getElementById('cancelModal').onclick = () => document.getElementById('infoModal').style.display = 'none';
    
    // ì €ì¥ ê¸°ëŠ¥ (ì´ë¯¸ì§€ë¡œ ì €ì¥)
    document.getElementById('downloadBtn').onclick = () => {
        const link = document.createElement('a');
        link.download = 'handwriting.png';
        // ê°€ì´ë“œì™€ ê¸€ì”¨ë¥¼ í•©ì³ì„œ ì €ì¥í•˜ê¸° ìœ„í•´ ì„ì‹œ ìº”ë²„ìŠ¤ ìƒì„±
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tCtx = tempCanvas.getContext('2d');
        tCtx.fillStyle = "#ffffff";
        tCtx.fillRect(0,0,tempCanvas.width, tempCanvas.height);
        tCtx.drawImage(guideCanvas, 0, 0);
        tCtx.drawImage(canvas, 0, 0);
        link.href = tempCanvas.toDataURL();
        link.click();
    };

    // êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
    document.getElementById('submitInfo').onclick = async () => {
        const sid = document.getElementById('studentId').value.trim();
        const sname = document.getElementById('studentName').value.trim();
        if (!sid || !sname) { alert("í•™ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        
        const btn = document.getElementById('submitInfo');
        const btnText = document.getElementById('btnText');
        btnText.innerHTML = '<span class="loading-spinner"></span>ê¸°ë¡ ì¤‘...';
        btn.disabled = true;

        const payload = { studentId: sid, name: sname, text: inputText.value, accuracy: currentAccuracy };

        try {
            await fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            alert("ì„±ê³µì ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
            document.getElementById('infoModal').style.display = 'none';
        } catch (e) {
            alert("ê¸°ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            btnText.innerText = 'ì‹œíŠ¸ì— ê¸°ë¡í•˜ê¸°';
            btn.disabled = false;
        }
    };
</script>

</body>
</html>
